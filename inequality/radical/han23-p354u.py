from sympy import *

# ISBN 9787312056185, p354, ex 11.20 (p113, ex 5.26)

def main():
    a, b, c, x, y, z = symbols('a, b, c, x, y, z')
    # -1 <= x, y, z <= 1
    g = x**2 + y**2 + z**2 - 2*x*y*z
    # condition: g <= 1
    g01 = solve(Eq(g, 1), z)
    # A*z**2 + B*z + C <= 0 and A > 0, hence z0 <= z <= z1
    print(g01[0], '<= z <=', g01[1])
    # -1 <= x, y <= 1 -> -1 <= z <= 1, see han23-p354a.py

    r, s, t, u, v, w, R, S, U, V = symbols('r, s, t, u, v, w, R, S, U, V', negative = False)
    a, b, x, y = 2/(1 + r) - 1, 2/(1 + s) - 1, 2/(1 + u) - 1, 2/(1 + v) - 1
    # R, S, U, V = sqrt(r), sqrt(s), sqrt(u), sqrt(v)
    # sqrt((x**2 - 1)*(y**2 - 1)) = 4*sqrt(u)*sqrt(v)/(u + 1)/(v + 1)
    RS = 4*R*S/(r + 1)/(s + 1)
    UV = 4*U*V/(u + 1)/(v + 1)
    c = a*b - RS + 2*RS/(1 + t)
    z = x*y - UV + 2*UV/(1 + w)
    # -1 <= z <= 1, verified by han23-p354b.py

    f = 1 + 2*a*b*c*x*y*z - (a*x)**2 - (b*y)**2 - (c*z)**2
    print('f =', factor(f))
    R2, S2, U2, V2 = r, s, u, v
    f = -16*R2*S2*U2*V2*t**2*w**2 + 32*R2*S2*U2*V2*t**2*w - 16*R2*S2*U2*V2*t**2 + 32*R2*S2*U2*V2*t*w**2 - 64*R2*S2*U2*V2*t*w + 32*R2*S2*U2*V2*t - 16*R2*S2*U2*V2*w**2 + 32*R2*S2*U2*V2*w - 16*R2*S2*U2*V2 + 8*R2*S2*U*V*t**2*u*v*w**2 - 8*R2*S2*U*V*t**2*u*v - 8*R2*S2*U*V*t**2*u*w**2 + 8*R2*S2*U*V*t**2*u - 8*R2*S2*U*V*t**2*v*w**2 + 8*R2*S2*U*V*t**2*v + 8*R2*S2*U*V*t**2*w**2 - 8*R2*S2*U*V*t**2 - 16*R2*S2*U*V*t*u*v*w**2 + 16*R2*S2*U*V*t*u*v + 16*R2*S2*U*V*t*u*w**2 - 16*R2*S2*U*V*t*u + 16*R2*S2*U*V*t*v*w**2 - 16*R2*S2*U*V*t*v - 16*R2*S2*U*V*t*w**2 + 16*R2*S2*U*V*t + 8*R2*S2*U*V*u*v*w**2 - 8*R2*S2*U*V*u*v - 8*R2*S2*U*V*u*w**2 + 8*R2*S2*U*V*u - 8*R2*S2*U*V*v*w**2 + 8*R2*S2*U*V*v + 8*R2*S2*U*V*w**2 - 8*R2*S2*U*V - R2*S2*t**2*u**2*v**2*w**2 - 2*R2*S2*t**2*u**2*v**2*w - R2*S2*t**2*u**2*v**2 + 2*R2*S2*t**2*u**2*v*w**2 + 4*R2*S2*t**2*u**2*v*w + 2*R2*S2*t**2*u**2*v - R2*S2*t**2*u**2*w**2 - 2*R2*S2*t**2*u**2*w - R2*S2*t**2*u**2 + 2*R2*S2*t**2*u*v**2*w**2 + 4*R2*S2*t**2*u*v**2*w + 2*R2*S2*t**2*u*v**2 - 4*R2*S2*t**2*u*v*w**2 - 8*R2*S2*t**2*u*v*w - 4*R2*S2*t**2*u*v + 2*R2*S2*t**2*u*w**2 + 4*R2*S2*t**2*u*w + 2*R2*S2*t**2*u - R2*S2*t**2*v**2*w**2 - 2*R2*S2*t**2*v**2*w - R2*S2*t**2*v**2 + 2*R2*S2*t**2*v*w**2 + 4*R2*S2*t**2*v*w + 2*R2*S2*t**2*v - R2*S2*t**2*w**2 - 2*R2*S2*t**2*w - R2*S2*t**2 + 2*R2*S2*t*u**2*v**2*w**2 + 4*R2*S2*t*u**2*v**2*w + 2*R2*S2*t*u**2*v**2 - 4*R2*S2*t*u**2*v*w**2 - 8*R2*S2*t*u**2*v*w - 4*R2*S2*t*u**2*v + 2*R2*S2*t*u**2*w**2 + 4*R2*S2*t*u**2*w + 2*R2*S2*t*u**2 - 4*R2*S2*t*u*v**2*w**2 - 8*R2*S2*t*u*v**2*w - 4*R2*S2*t*u*v**2 + 8*R2*S2*t*u*v*w**2 + 16*R2*S2*t*u*v*w + 8*R2*S2*t*u*v - 4*R2*S2*t*u*w**2 - 8*R2*S2*t*u*w - 4*R2*S2*t*u + 2*R2*S2*t*v**2*w**2 + 4*R2*S2*t*v**2*w + 2*R2*S2*t*v**2 - 4*R2*S2*t*v*w**2 - 8*R2*S2*t*v*w - 4*R2*S2*t*v + 2*R2*S2*t*w**2 + 4*R2*S2*t*w + 2*R2*S2*t - R2*S2*u**2*v**2*w**2 - 2*R2*S2*u**2*v**2*w - R2*S2*u**2*v**2 + 2*R2*S2*u**2*v*w**2 + 4*R2*S2*u**2*v*w + 2*R2*S2*u**2*v - R2*S2*u**2*w**2 - 2*R2*S2*u**2*w - R2*S2*u**2 + 2*R2*S2*u*v**2*w**2 + 4*R2*S2*u*v**2*w + 2*R2*S2*u*v**2 - 4*R2*S2*u*v*w**2 - 8*R2*S2*u*v*w - 4*R2*S2*u*v + 2*R2*S2*u*w**2 + 4*R2*S2*u*w + 2*R2*S2*u - R2*S2*v**2*w**2 - 2*R2*S2*v**2*w - R2*S2*v**2 + 2*R2*S2*v*w**2 + 4*R2*S2*v*w + 2*R2*S2*v - R2*S2*w**2 - 2*R2*S2*w - R2*S2 + 8*R*S*U2*V2*r*s*t**2*w**2 - 16*R*S*U2*V2*r*s*t**2*w + 8*R*S*U2*V2*r*s*t**2 - 8*R*S*U2*V2*r*s*w**2 + 16*R*S*U2*V2*r*s*w - 8*R*S*U2*V2*r*s - 8*R*S*U2*V2*r*t**2*w**2 + 16*R*S*U2*V2*r*t**2*w - 8*R*S*U2*V2*r*t**2 + 8*R*S*U2*V2*r*w**2 - 16*R*S*U2*V2*r*w + 8*R*S*U2*V2*r - 8*R*S*U2*V2*s*t**2*w**2 + 16*R*S*U2*V2*s*t**2*w - 8*R*S*U2*V2*s*t**2 + 8*R*S*U2*V2*s*w**2 - 16*R*S*U2*V2*s*w + 8*R*S*U2*V2*s + 8*R*S*U2*V2*t**2*w**2 - 16*R*S*U2*V2*t**2*w + 8*R*S*U2*V2*t**2 - 8*R*S*U2*V2*w**2 + 16*R*S*U2*V2*w - 8*R*S*U2*V2 - 2*R*S*U*V*r*s*t**2*u*v*w**2 + 2*R*S*U*V*r*s*t**2*u*v + 2*R*S*U*V*r*s*t**2*u*w**2 - 2*R*S*U*V*r*s*t**2*u + 2*R*S*U*V*r*s*t**2*v*w**2 - 2*R*S*U*V*r*s*t**2*v - 2*R*S*U*V*r*s*t**2*w**2 + 2*R*S*U*V*r*s*t**2 + 2*R*S*U*V*r*s*u*v*w**2 - 2*R*S*U*V*r*s*u*v - 2*R*S*U*V*r*s*u*w**2 + 2*R*S*U*V*r*s*u - 2*R*S*U*V*r*s*v*w**2 + 2*R*S*U*V*r*s*v + 2*R*S*U*V*r*s*w**2 - 2*R*S*U*V*r*s + 2*R*S*U*V*r*t**2*u*v*w**2 - 2*R*S*U*V*r*t**2*u*v - 2*R*S*U*V*r*t**2*u*w**2 + 2*R*S*U*V*r*t**2*u - 2*R*S*U*V*r*t**2*v*w**2 + 2*R*S*U*V*r*t**2*v + 2*R*S*U*V*r*t**2*w**2 - 2*R*S*U*V*r*t**2 - 2*R*S*U*V*r*u*v*w**2 + 2*R*S*U*V*r*u*v + 2*R*S*U*V*r*u*w**2 - 2*R*S*U*V*r*u + 2*R*S*U*V*r*v*w**2 - 2*R*S*U*V*r*v - 2*R*S*U*V*r*w**2 + 2*R*S*U*V*r + 2*R*S*U*V*s*t**2*u*v*w**2 - 2*R*S*U*V*s*t**2*u*v - 2*R*S*U*V*s*t**2*u*w**2 + 2*R*S*U*V*s*t**2*u - 2*R*S*U*V*s*t**2*v*w**2 + 2*R*S*U*V*s*t**2*v + 2*R*S*U*V*s*t**2*w**2 - 2*R*S*U*V*s*t**2 - 2*R*S*U*V*s*u*v*w**2 + 2*R*S*U*V*s*u*v + 2*R*S*U*V*s*u*w**2 - 2*R*S*U*V*s*u + 2*R*S*U*V*s*v*w**2 - 2*R*S*U*V*s*v - 2*R*S*U*V*s*w**2 + 2*R*S*U*V*s - 2*R*S*U*V*t**2*u*v*w**2 + 2*R*S*U*V*t**2*u*v + 2*R*S*U*V*t**2*u*w**2 - 2*R*S*U*V*t**2*u + 2*R*S*U*V*t**2*v*w**2 - 2*R*S*U*V*t**2*v - 2*R*S*U*V*t**2*w**2 + 2*R*S*U*V*t**2 + 2*R*S*U*V*u*v*w**2 - 2*R*S*U*V*u*v - 2*R*S*U*V*u*w**2 + 2*R*S*U*V*u - 2*R*S*U*V*v*w**2 + 2*R*S*U*V*v + 2*R*S*U*V*w**2 - 2*R*S*U*V - U2*V2*r**2*s**2*t**2*w**2 + 2*U2*V2*r**2*s**2*t**2*w - U2*V2*r**2*s**2*t**2 - 2*U2*V2*r**2*s**2*t*w**2 + 4*U2*V2*r**2*s**2*t*w - 2*U2*V2*r**2*s**2*t - U2*V2*r**2*s**2*w**2 + 2*U2*V2*r**2*s**2*w - U2*V2*r**2*s**2 + 2*U2*V2*r**2*s*t**2*w**2 - 4*U2*V2*r**2*s*t**2*w + 2*U2*V2*r**2*s*t**2 + 4*U2*V2*r**2*s*t*w**2 - 8*U2*V2*r**2*s*t*w + 4*U2*V2*r**2*s*t + 2*U2*V2*r**2*s*w**2 - 4*U2*V2*r**2*s*w + 2*U2*V2*r**2*s - U2*V2*r**2*t**2*w**2 + 2*U2*V2*r**2*t**2*w - U2*V2*r**2*t**2 - 2*U2*V2*r**2*t*w**2 + 4*U2*V2*r**2*t*w - 2*U2*V2*r**2*t - U2*V2*r**2*w**2 + 2*U2*V2*r**2*w - U2*V2*r**2 + 2*U2*V2*r*s**2*t**2*w**2 - 4*U2*V2*r*s**2*t**2*w + 2*U2*V2*r*s**2*t**2 + 4*U2*V2*r*s**2*t*w**2 - 8*U2*V2*r*s**2*t*w + 4*U2*V2*r*s**2*t + 2*U2*V2*r*s**2*w**2 - 4*U2*V2*r*s**2*w + 2*U2*V2*r*s**2 - 4*U2*V2*r*s*t**2*w**2 + 8*U2*V2*r*s*t**2*w - 4*U2*V2*r*s*t**2 - 8*U2*V2*r*s*t*w**2 + 16*U2*V2*r*s*t*w - 8*U2*V2*r*s*t - 4*U2*V2*r*s*w**2 + 8*U2*V2*r*s*w - 4*U2*V2*r*s + 2*U2*V2*r*t**2*w**2 - 4*U2*V2*r*t**2*w + 2*U2*V2*r*t**2 + 4*U2*V2*r*t*w**2 - 8*U2*V2*r*t*w + 4*U2*V2*r*t + 2*U2*V2*r*w**2 - 4*U2*V2*r*w + 2*U2*V2*r - U2*V2*s**2*t**2*w**2 + 2*U2*V2*s**2*t**2*w - U2*V2*s**2*t**2 - 2*U2*V2*s**2*t*w**2 + 4*U2*V2*s**2*t*w - 2*U2*V2*s**2*t - U2*V2*s**2*w**2 + 2*U2*V2*s**2*w - U2*V2*s**2 + 2*U2*V2*s*t**2*w**2 - 4*U2*V2*s*t**2*w + 2*U2*V2*s*t**2 + 4*U2*V2*s*t*w**2 - 8*U2*V2*s*t*w + 4*U2*V2*s*t + 2*U2*V2*s*w**2 - 4*U2*V2*s*w + 2*U2*V2*s - U2*V2*t**2*w**2 + 2*U2*V2*t**2*w - U2*V2*t**2 - 2*U2*V2*t*w**2 + 4*U2*V2*t*w - 2*U2*V2*t - U2*V2*w**2 + 2*U2*V2*w - U2*V2 + r**2*s**2*t**2*u*v*w**2 + 2*r**2*s**2*t**2*u*v*w + r**2*s**2*t**2*u*v + 2*r**2*s**2*t*u*v*w**2 + 4*r**2*s**2*t*u*v*w + 2*r**2*s**2*t*u*v + r**2*s**2*u*v*w**2 + 2*r**2*s**2*u*v*w + r**2*s**2*u*v + r**2*s*t**2*u*v**2*w**2 + 2*r**2*s*t**2*u*v**2*w + r**2*s*t**2*u*v**2 + r**2*s*t**2*u*w**2 + 2*r**2*s*t**2*u*w + r**2*s*t**2*u + 2*r**2*s*t*u*v**2*w**2 + 4*r**2*s*t*u*v**2*w + 2*r**2*s*t*u*v**2 + 2*r**2*s*t*u*w**2 + 4*r**2*s*t*u*w + 2*r**2*s*t*u + r**2*s*u*v**2*w**2 + 2*r**2*s*u*v**2*w + r**2*s*u*v**2 + r**2*s*u*w**2 + 2*r**2*s*u*w + r**2*s*u + r**2*t**2*u*v*w**2 + 2*r**2*t**2*u*v*w + r**2*t**2*u*v + 2*r**2*t*u*v*w**2 + 4*r**2*t*u*v*w + 2*r**2*t*u*v + r**2*u*v*w**2 + 2*r**2*u*v*w + r**2*u*v + r*s**2*t**2*u**2*v*w**2 + 2*r*s**2*t**2*u**2*v*w + r*s**2*t**2*u**2*v + r*s**2*t**2*v*w**2 + 2*r*s**2*t**2*v*w + r*s**2*t**2*v + 2*r*s**2*t*u**2*v*w**2 + 4*r*s**2*t*u**2*v*w + 2*r*s**2*t*u**2*v + 2*r*s**2*t*v*w**2 + 4*r*s**2*t*v*w + 2*r*s**2*t*v + r*s**2*u**2*v*w**2 + 2*r*s**2*u**2*v*w + r*s**2*u**2*v + r*s**2*v*w**2 + 2*r*s**2*v*w + r*s**2*v + r*s*t**2*u**2*v**2*w**2 + 2*r*s*t**2*u**2*v**2*w + r*s*t**2*u**2*v**2 + r*s*t**2*u**2*w**2 + 2*r*s*t**2*u**2*w + r*s*t**2*u**2 + r*s*t**2*v**2*w**2 + 2*r*s*t**2*v**2*w + r*s*t**2*v**2 + r*s*t**2*w**2 + 2*r*s*t**2*w + r*s*t**2 + 2*r*s*t*u**2*v**2*w**2 + 4*r*s*t*u**2*v**2*w + 2*r*s*t*u**2*v**2 + 2*r*s*t*u**2*w**2 + 4*r*s*t*u**2*w + 2*r*s*t*u**2 + 2*r*s*t*v**2*w**2 + 4*r*s*t*v**2*w + 2*r*s*t*v**2 + 2*r*s*t*w**2 + 4*r*s*t*w + 2*r*s*t + r*s*u**2*v**2*w**2 + 2*r*s*u**2*v**2*w + r*s*u**2*v**2 + r*s*u**2*w**2 + 2*r*s*u**2*w + r*s*u**2 + r*s*v**2*w**2 + 2*r*s*v**2*w + r*s*v**2 + r*s*w**2 + 2*r*s*w + r*s + r*t**2*u**2*v*w**2 + 2*r*t**2*u**2*v*w + r*t**2*u**2*v + r*t**2*v*w**2 + 2*r*t**2*v*w + r*t**2*v + 2*r*t*u**2*v*w**2 + 4*r*t*u**2*v*w + 2*r*t*u**2*v + 2*r*t*v*w**2 + 4*r*t*v*w + 2*r*t*v + r*u**2*v*w**2 + 2*r*u**2*v*w + r*u**2*v + r*v*w**2 + 2*r*v*w + r*v + s**2*t**2*u*v*w**2 + 2*s**2*t**2*u*v*w + s**2*t**2*u*v + 2*s**2*t*u*v*w**2 + 4*s**2*t*u*v*w + 2*s**2*t*u*v + s**2*u*v*w**2 + 2*s**2*u*v*w + s**2*u*v + s*t**2*u*v**2*w**2 + 2*s*t**2*u*v**2*w + s*t**2*u*v**2 + s*t**2*u*w**2 + 2*s*t**2*u*w + s*t**2*u + 2*s*t*u*v**2*w**2 + 4*s*t*u*v**2*w + 2*s*t*u*v**2 + 2*s*t*u*w**2 + 4*s*t*u*w + 2*s*t*u + s*u*v**2*w**2 + 2*s*u*v**2*w + s*u*v**2 + s*u*w**2 + 2*s*u*w + s*u + t**2*u*v*w**2 + 2*t**2*u*v*w + t**2*u*v + 2*t*u*v*w**2 + 4*t*u*v*w + 2*t*u*v + u*v*w**2 + 2*u*v*w + u*v
    f = expand(f.subs(r, R**2).subs(s, S**2).subs(u, U**2).subs(v, V**2))
    print('f =', f)

if __name__ == '__main__':
    main()